name: Rotate Board Images

on:
  workflow_run:
    workflows: ["Export KiCad Images"]
    types: [completed]

permissions:
  contents: write

jobs:
  rotate-images:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick inkscape

      - name: Rotate 3D renders (PNG)
        run: |
          convert images/board.front.png -rotate 90 images/tmp.png && mv images/tmp.png images/board.front.png
          convert images/board.back.png  -rotate 180 images/tmp.png && mv images/tmp.png images/board.back.png

      - name: Rotate back silkscreen (SVG)
        run: |
          inkscape images/pcbb.svg \
            --batch-process \
            --actions="select-all;transform-rotate:180;fitcanvas-to-drawing;export-filename:images/tmp.svg;export-do"
          mv images/tmp.svg images/pcbb.svg

      - name: Configure Git
        run: |
          git config user.name "Image Rotate App"
          git config user.email "123456+MyImageApp[bot]@users.noreply.github.com"

      - name: Commit and push
        run: |
          git add images/*
          git commit -m "Rotate board images" || echo "No changes to commit."
          git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          git push origin HEAD:main
